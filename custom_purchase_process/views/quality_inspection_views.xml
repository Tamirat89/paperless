<odoo>

    <record id="view_quality_inspection_form" model="ir.ui.view">
        <field name="name">quality.inspection.form</field>
        <field name="model">quality.inspection</field>
        <field name="arch" type="xml">
            <form string="Quality Assurance">
                <header>
                    <field name="state" widget="statusbar"
                           statusbar_visible="draft,requested_docs,approved,failed"/>
                    <button name="action_request_documents" string="Submit" type="object" class="btn-primary"
                            groups="custom_purchase_process.group_quality_inspection_user"
                            invisible="state != 'draft'"/>
                    <button name="action_approve" string="Approve Inspection" type="object" class="btn-success"
                            groups="custom_purchase_process.group_quality_inspection_approver"
                            invisible="state != 'requested_docs'"/>
                    <button name="action_reset_to_draft" string="Reset to Draft" type="object" class="btn-secondary"
                            groups="custom_purchase_process.group_quality_inspection_approver"
                            invisible="state == 'draft' or state == 'approved'"/>
                </header>
                <sheet>
                    <group>
                        <field name="name" readonly="1" class="o_inline_display"/>
                        <field name="state" invisible="1"/>
                        <field name="requested_date" readonly="1"/>
                        <field name="inspected_date" readonly="1"/>
                        <field name="inspected_by" readonly="1"/>
                        <field name="partner_id" string="Vendor" readonly="1"/>
                        <field name="supplier_analysis_id" string="Supplier Analysis" readonly="1"/>
                    </group>
                    <notebook>
                        <page string="Inspection Lines">
                            <field name="quality_inspections_line_ids" nolabel="1" widget="one2many_list" mode="list" options="{'no_create': True, 'no_create_edit': True}">
                                <list editable="bottom" create="0" delete="0">
                                    <field name="product_id" string="Product" readonly="1"/>
                                    <field name="name" string="Description" readonly="1"/>
                                    <field name="inspection_status" string="Inspection Status" readonly="parent.state == 'approved'"/>
                                    <field name="passed_inspection" string="Passed" widget="boolean_toggle" readonly="parent.state == 'approved'"/>
                                    <field name="failed_inspection" string="Failed" widget="boolean_toggle" readonly="parent.state == 'approved'"/>
                                    <field name="inspection_remark" string="Remark" readonly="parent.state == 'approved'"/>
                                </list>
                                <form>
                                    <group>
                                        <field name="product_id" string="Product"/>
                                        <field name="name" string="Description"/>
                                        <field name="passed_inspection" string="Passed"/>
                                        <field name="inspection_remark" string="Remark"/>
                                    </group>
                                </form>
                            </field>
                        </page>
                    </notebook>
                </sheet>
                <chatter/>
            </form>
        </field>
    </record>

    <record id="view_quality_inspection_tree" model="ir.ui.view">
        <field name="name">quality.inspection.tree</field>
        <field name="model">quality.inspection</field>
        <field name="arch" type="xml">
            <list default_order="requested_date desc" create="0" delete="0">
                <field name="name" string="Inspection Reference"/>
                <field name="partner_id" string="Vendor"/>
                <field name="state" string="Status"/>
                <field name="requested_date" string="Requested Date"/>
                <field name="inspected_date" string="Inspected Date"/>
            </list>
        </field>
    </record>

    <!-- Admin view with create and delete enabled -->
    <record id="view_quality_inspection_tree_admin" model="ir.ui.view">
        <field name="name">quality.inspection.tree.admin</field>
        <field name="model">quality.inspection</field>
        <field name="inherit_id" ref="view_quality_inspection_tree"/>
        <field name="arch" type="xml">
            <list position="attributes">
                <attribute name="create">1</attribute>
                <attribute name="delete">1</attribute>
            </list>
        </field>
    </record>

    <record id="action_quality_inspection" model="ir.actions.act_window">
        <field name="name">Quality Assurance</field>
        <field name="res_model">quality.inspection</field>
        <field name="view_mode">list,form</field>
        <field name="context">{'create': False}</field>
        <field name="help" type="html">
            <p class="oe_view_nocontent_create">
                Quality inspections can only be created from Supplier Analysis.
            </p>
        </field>
    </record>

    <record id="view_quality_inspection_search" model="ir.ui.view">
        <field name="name">quality.inspection.search</field>
        <field name="model">quality.inspection</field>
        <field name="arch" type="xml">
            <search string="Quality Inspection">
                <field name="name"/>
                <field name="partner_id"/>
                <field name="supplier_analysis_id"/>
                <field name="state"/>
                <!-- <filter string="Today" name="filter_today" domain="[('requested_date', '=', context_today())]"/>
                <filter string="This Week" name="filter_week" domain="[('requested_date', '&gt;=', (datetime.datetime.combine(context_today() - datetime.timedelta(days=context_today().weekday()), datetime.time(0,0,0))).strftime('%Y-%m-%d')), ('requested_date', '&lt;=', (datetime.datetime.combine(context_today() + datetime.timedelta(days=6-context_today().weekday()), datetime.time(23,59,59))).strftime('%Y-%m-%d'))]"/>
                <filter string="This Month" name="filter_month" domain="[('requested_date', '&gt;=', (datetime.datetime.combine(context_today().replace(day=1), datetime.time(0,0,0))).strftime('%Y-%m-%d')), ('requested_date', '&lt;=', (datetime.datetime.combine((context_today().replace(day=1) + datetime.timedelta(days=32)).replace(day=1) - datetime.timedelta(days=1), datetime.time(23,59,59))).strftime('%Y-%m-%d'))]"/> -->
                <!-- <separator/> -->
                <!-- <filter string="Draft" name="filter_draft" domain="[('state', '=', 'draft')]"/>
                <filter string="Requested" name="filter_requested" domain="[('state', '=', 'requested_docs')]"/>
                <filter string="Approved" name="filter_approved" domain="[('state', '=', 'approved')]"/> -->
                <!-- <separator/> -->
                <filter string="State" name="group_by_state" context="{'group_by': 'state'}"/>
                <!-- <filter string="Vendor" name="group_by_vendor" context="{'group_by': 'partner_id'}"/> -->
                <!-- <filter string="Supplier Analysis" name="group_by_analysis" context="{'group_by': 'supplier_analysis_id'}"/> -->
            </search>
        </field>
    </record>

    <record id="action_quality_inspection_users" model="ir.actions.act_window">
        <field name="name">Quality Inspection</field>
        <field name="res_model">quality.inspection</field>
        <field name="view_mode">list,form</field>
        <field name="search_view_id" ref="view_quality_inspection_search"/>
        <field name="context">{'search_default_filter_today': 1, 'search_default_group_by_state': 1, 'create': False}</field>
        <field name="help" type="html">
            <p class="oe_view_nocontent_create">
                Quality inspections can only be created from Supplier Analysis.
            </p>
        </field>
    </record>

    <!-- Admin form view with create/delete enabled for lines -->
    <record id="view_quality_inspection_form_admin" model="ir.ui.view">
        <field name="name">quality.inspection.form.admin</field>
        <field name="model">quality.inspection</field>
        <field name="inherit_id" ref="view_quality_inspection_form"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='quality_inspections_line_ids']" position="attributes">
                <attribute name="options">{}</attribute>
            </xpath>
            <xpath expr="//field[@name='quality_inspections_line_ids']//list" position="attributes">
                <attribute name="create">1</attribute>
                <attribute name="delete">1</attribute>
            </xpath>
        </field>
    </record>

    <!-- Admin action with create enabled -->
    <record id="action_quality_inspection_admin" model="ir.actions.act_window">
        <field name="name">Quality Inspection</field>
        <field name="res_model">quality.inspection</field>
        <field name="view_mode">list,form</field>
        <field name="view_ids" eval="[(5, 0, 0),
            (0, 0, {'view_mode': 'list', 'view_id': ref('view_quality_inspection_tree_admin')}),
            (0, 0, {'view_mode': 'form', 'view_id': ref('view_quality_inspection_form_admin')})]"/>
        <field name="search_view_id" ref="view_quality_inspection_search"/>
        <field name="context">{'search_default_filter_today': 1, 'search_default_group_by_state': 1}</field>
    </record>

    <!-- Add Quality Inspection menu for supplier analysis users -->
    <menuitem id="menu_quality_inspection_supplier_analysis"
              name="Quality Inspection"
              parent="menu_supplier_analysis_root_menu"
              action="action_quality_inspection_users"
              groups="custom_purchase_process.group_supplier_analysis_user"
              sequence="2"/>

    <menuitem id="menu_quality_inspection_supplier_analysis_view_root"
              name="Quality Inspection"
              web_icon="custom_purchase_process,static/description/icon3.png"
              groups="custom_purchase_process.group_quality_inspection_user,custom_purchase_process.group_quality_inspection_approver"
              />

    <menuitem id="menu_quality_inspection_supplier_analysis_view_menu"
              name="Quality Inspection"
              parent="menu_quality_inspection_supplier_analysis_view_root"
              action="action_quality_inspection_users"
              sequence="1"
              groups="custom_purchase_process.group_quality_inspection_user,custom_purchase_process.group_quality_inspection_approver"
              />
    
    <!-- Admin menu with create enabled -->
    <menuitem id="menu_quality_inspection_admin"
              name="Quality Inspection"
              parent="menu_quality_inspection_supplier_analysis_view_root"
              action="action_quality_inspection_admin"
              sequence="1"
              groups="custom_purchase_process.group_quality_inspection_admin"
              />

    <record id="view_supplier_analysis_form_inherit_quality_inspection" model="ir.ui.view">
        <field name="name">supplier.analysis.form.inherit.quality_inspection</field>
        <field name="model">supplier.analysis</field>
        <field name="inherit_id" ref="custom_purchase_process.view_supplier_analysis_form"/>
        <field name="arch" type="xml">
            <xpath expr="//div[@name='button_box']" position="inside">
            
                <button name="action_view_quality_inspection" string="Quality Inspection" type="object" class="btn-primary"
                        count="quality_inspection_count"
                        icon="fa-external-link"
                        invisible="quality_inspection_count == 0">
                        <div class="o_stat_info">
                            <span class="o_stat_value">
                                <field name="quality_inspection_count" widget="statinfo" string="Quality Inspection(s)"/>
                            </span>
                        </div>
                    </button>
            </xpath>
        </field>
    </record>
</odoo>